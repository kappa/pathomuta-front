<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="/kappa/favicon.ico">

    <title>Патогенные мутации</title>

    <!-- Bootstrap core CSS -->
    <link href="/kappa/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap theme -->
    <link href="/kappa/css/bootstrap-theme.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body role="document">

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Пациенты:</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">(выбор) <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu" id="vcf-menu">
    <script id="tmpl-vcf-menu" type="text/html">
	{{#vcfs}}
	<li><a href=# data-id="{{id}}">{{name}}</a></li>
	{{/vcfs}}
    </script>
              </ul>
            </li>
            <li><a href="#about">О проекте</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container theme-showcase" role="main">

     <div class="jumbotron">
	     <h1>Патогенные мутации</h1>
	<p>Просмотр информации о патогенных мутациях в геномных
	последовательностях пациентов. Выберите вариант из меню выше
	для просмотра информации об имеющихся патогенных мутациях.</p>
</div>

<div id="vcf-info">
</div>

<script type="text/html" id="tmpl-vcf-info">
      <div class="page-header">
	      <h1>{{ name }}</h1>
      </div>

      <div class="row">
        <div class="col-md-6" style="overflow-y: scroll; overflow-x: hidden; max-height: 500px">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Ген</th>
                <th>Мутации в этом гене</th>
              </tr>
            </thead>
            <tbody>
	      {{#genes}}
              <tr>
		<td style="width: 15m; overflow: hidden;"><span class="label label-default"
			data-id="{{ id }}">{{ name }}</span></td>
                <td>
		{{#mut_count}}
			{{ mut_count }} мутаций скрыто
		{{/mut_count}}
		{{^mut_count}}
		{{#mutations}}
		<a href=# data-id="{{ ID }}">rs{{ rsId }}</a>
		{{/mutations}}
		{{/mut_count}}
		</td>
              </tr>
	      {{/genes}}
            </tbody>
          </table>
        </div>
	<div class="col-md-6">
		<div class="panel panel-primary" id="mutation">
		    <div class="panel-heading">
		      <h3 class="panel-title"></h3>
		    </div>
		    <div class="panel-body">
			<p>Выберите мутацию слева</p>
		    </div>
		</div>
	</div>
      </div>
</script>

<script type="text/html" id="tmpl-mutation-info">
		    <div class="panel-heading">
		      <h3 class="panel-title">rs{{ name }}</h3>
		    </div>
		    <div class="panel-body" style="overflow: hidden">
			  <table class="table">
			    <thead>
			      <tr>
				<th>Характеристика</th>
				<th>Значение</th>
			      </tr>
			    </thead>
			    <tbody>
		      {{#content}}
			{{#val}}
			      <tr>
				<td>{{ key }}</td>
				<td>{{ val }}</td>
			      </tr>
			{{/val}}
		      {{/content}}
			    </tbody>
			  </table>
		    </div>
</script>

    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="/kappa/js/bootstrap.min.js"></script>
    <script src="https://cdn.rawgit.com/jonnyreeves/jquery-Mustache/master/jquery.mustache.js"></script>
    <script src="https://cdn.rawgit.com/janl/mustache.js/master/mustache.js"></script>

<script>
function load_vcf(ev) {
	var vcf = {
		name : "vcfBeta-NA18504-200-37-ASM.vcf",
		genes : [
		{
			id : 1,
			name : "AKAP",
			mutations : [
			{ id : 334, name : "rs123123" },
			{ id : 334, name : "rs12sdfsd"}
			     ]
		},
		{
			id : 2,
			name : "GSTK",
			mutations : [
			{ id : 334, name : "rs123123" },
			{ id : 334, name : "rs12sdfsd"}
			    ]
		}
	    ]
	};

	var id = $(this).data('id');
	$.get('/cgi-bin/get-vcf?id=' + id).done(function(data) {
		var vcf = $.parseJSON(data);

		vcf.genes.forEach(function (el, el_i, arr) {
		    if (el.name == "Unknown_gene") {
			el.mut_count = el.mutations.length;
			el.mutations = [ ];
		    }

		    if (el.name.length > 20)
			el.name = el.name.substring(0, 15) + "...";
		});
		vcf.genes.sort(function (a, b) { return b.mutations.length - a.mutations.length });

		$('#vcf-info').mustache('tmpl-vcf-info', vcf, { method : 'html' });
		$('#vcf-info a').click(load_mutation);
	    });

	ev.preventDefault();
}

function map2arr(obj) {
	return Object.getOwnPropertyNames(obj).sort().map(
	    function(key) { return { "key" : key, "val" : obj[key] }; } );
}

function load_mutation(ev) {
	var id = $(this).data('id');
	$.get('/cgi-bin/get-mutation?id=' + id).done(function(data) {
		var mu = $.parseJSON(data)[0];
		delete mu.id;
		mu.content = map2arr(mu).filter(function (el, el_i, arr) {
		    return el.val && el.val != '.';
		});
		mu.name = mu.rsId;

		$('#mutation').mustache('tmpl-mutation-info', mu,
		    { method : 'html' });
	    });

	ev.preventDefault();
}

$(function() {
	$.Mustache.addFromDom();

	$.get('/cgi-bin/list-vcfs').done(function(data) {
		var vcfs = $.parseJSON(data);

		$('#vcf-menu').mustache('tmpl-vcf-menu', { vcfs : vcfs }, { method : 'html' });
		$('#vcf-menu a').click(load_vcf);
	});
});
</script>

  </body>
</html>
